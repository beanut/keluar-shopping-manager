<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keluar Admin Panel</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --success-color: #28a745;
            --light-gray: #f4f4f9;
            --dark-gray: #333;
            --border-color: #ddd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            margin: 0;
            padding: 20px;
        }
        #app-container {
            background: white;
            padding: 25px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
        nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
        }
        .nav-btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: black;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        h1, h2 { text-align: center; color: var(--dark-gray); }
        h2 { margin-top: 40px; border-top: 1px dashed var(--border-color); padding-top: 30px;}
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            padding: 15px;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary { width: 100%; background-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger-color); font-size: 14px; padding: 8px 12px; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .status-message { text-align: center; margin-top: 20px; font-weight: bold; min-height: 24px; }
        .success { color: var(--success-color); }
        .error { color: var(--error-color); }
        .management-list { list-style: none; padding: 0; }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .list-item-info { display: flex; flex-direction: column; }
        .list-item-info strong { font-size: 1.1em; }
        .list-item-info span { color: #666; font-size: 0.9em; }
        .content-section { display: none; }
        .content-section.active { display: block; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Keluar Shopping Management Portal</h1>
        <nav>
            <button class="nav-btn active" data-target="add-product-section">Add Product</button>
            <button class="nav-btn" data-target="manage-products-section">Manage Products</button>
            <button class="nav-btn" data-target="manage-promos-section">Manage Promos</button>
        </nav>

        <!-- Section 1: Add Product -->
        <section id="add-product-section" class="content-section active">
            <h1>Add New Product</h1>
            <form id="product-form">
                <!-- Form fields from previous version -->
                <div class="form-group"><label for="name">Product Name</label><input type="text" id="name" required></div>
                <div class="form-group"><label for="category">Category</label><input list="category-list" type="text" id="category" required><datalist id="category-list"></datalist></div>
                <div class="form-group"><label for="price">Price</label><input type="number" id="price" min="0" step="0.01" required></div>
                <div class="form-group"><label for="description">Description</label><textarea id="description" required></textarea></div>
                <div class="form-group"><label for="imageUrl">Image URL</label><input type="url" id="imageUrl" required></div>
                <div class="form-group"><label for="rating">Rating (0.0 - 5.0)</label><input type="number" id="rating" min="0" max="5" step="0.1"></div>
                <button type="submit" id="add-product-btn" class="btn-primary">Add Product</button>
            </form>
            <p id="add-product-status" class="status-message"></p>
        </section>

        <!-- Section 2: Manage Products -->
        <section id="manage-products-section" class="content-section">
            <h1>Manage Products</h1>
            <div id="product-list-container"></div>
        </section>

        <!-- Section 3: Manage Promo Codes -->
        <section id="manage-promos-section" class="content-section">
            <h1>Manage Promo Codes</h1>
            <form id="promo-form">
                <h2>Create New Promo Code</h2>
                <div class="form-group"><label for="promo-code">Promo Code (e.g., WINTER25)</label><input type="text" id="promo-code" required></div>
                <div class="form-group"><label for="discount-type">Discount Type</label><select id="discount-type"><option value="PERCENTAGE">Percentage</option><option value="FIXED">Fixed Amount</option></select></div>
                <div class="form-group"><label for="promo-value">Value (e.g., 25 for % or 10.00 for fixed)</label><input type="number" id="promo-value" min="0" step="0.01" required></div>
                <div class="form-group"><label for="promo-expiry">Expiry Date</label><input type="date" id="promo-expiry"></div>
                <div class="form-group"><label for="promo-min-value">Minimum Cart Value (optional)</label><input type="number" id="promo-min-value" min="0" step="0.01" placeholder="0.00"></div>
                <button type="submit" id="add-promo-btn" class="btn-primary">Create Promo Code</button>
            </form>
            <p id="add-promo-status" class="status-message"></p>

            <h2>Existing Promo Codes</h2>
            <div id="promo-list-container"></div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyDmLhttC8aXZIWoIQM95Id_vPe7gObgkeg",
  authDomain: "keluar-a4469.firebaseapp.com",
  projectId: "keluar-a4469",
  storageBucket: "keluar-a4469.firebasestorage.app",
  messagingSenderId: "578437338277",
  appId: "1:578437338277:web:a3faa6371ea9bffb8ee94c",
  measurementId: "G-21EBQDERCG"
};
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            // --- Navigation ---
            const navButtons = document.querySelectorAll('.nav-btn');
            const contentSections = document.querySelectorAll('.content-section');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.target).classList.add('active');
                });
            });

            // --- Load Initial Data ---
            loadCategories();
            loadProductsToDelete();
            loadPromosToDelete();

            // --- Add Product Logic ---
            const productForm = document.getElementById('product-form');
            productForm.addEventListener('submit', handleAddProduct);

            // --- Add Promo Logic ---
            const promoForm = document.getElementById('promo-form');
            promoForm.addEventListener('submit', handleAddPromo);
            
            // --- Delete Logic (Event Delegation) ---
            document.getElementById('product-list-container').addEventListener('click', handleDeleteProduct);
            document.getElementById('promo-list-container').addEventListener('click', handleDeletePromo);
        });

        // --- CATEGORY LOADER ---
        async function loadCategories() {
            const categoryList = document.getElementById('category-list');
            try {
                const snapshot = await db.collection('categories').get();
                categoryList.innerHTML = '';
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.data().name;
                    categoryList.appendChild(option);
                });
            } catch (error) { console.error("Error loading categories:", error); }
        }
        
        // --- ADD PRODUCT HANDLER ---
        async function handleAddProduct(e) {
            e.preventDefault();
            const btn = document.getElementById('add-product-btn');
            const status = document.getElementById('add-product-status');
            btn.disabled = true;
            status.textContent = 'Submitting...'; status.className = 'status-message';
            try {
                const newProductRef = db.collection('products').doc();
                const productData = {
                    id: newProductRef.id, name: document.getElementById('name').value,
                    category: document.getElementById('category').value.trim(),
                    description: document.getElementById('description').value,
                    imageUrl: document.getElementById('imageUrl').value,
                    price: parseFloat(document.getElementById('price').value) || 0,
                    rating: parseFloat(document.getElementById('rating').value) || 0,
                };
                const categoryName = productData.category;
                const categoryRef = db.collection('categories').doc(categoryName);
                const categoryDoc = await categoryRef.get();
                if (!categoryDoc.exists) {
                    await categoryRef.set({ name: categoryName });
                    await loadCategories(); // Reload categories
                }
                await newProductRef.set(productData);
                status.textContent = 'Product added successfully!'; status.className = 'status-message success';
                productForm.reset();
                await loadProductsToDelete(); // Refresh list
            } catch (error) {
                console.error("Error adding product:", error);
                status.textContent = `Error: ${error.message}`; status.className = 'status-message error';
            } finally { btn.disabled = false; }
        }

        // --- ADD PROMO HANDLER ---
        async function handleAddPromo(e) {
            e.preventDefault();
            const btn = document.getElementById('add-promo-btn');
            const status = document.getElementById('add-promo-status');
            btn.disabled = true;
            status.textContent = 'Submitting...'; status.className = 'status-message';
            const code = document.getElementById('promo-code').value.trim().toUpperCase();
            if (!code) {
                status.textContent = 'Promo Code cannot be empty.'; status.className = 'status-message error';
                btn.disabled = false;
                return;
            }
            try {
                const expiryDate = document.getElementById('promo-expiry').value;
                const promoData = {
                    code: code,
                    discountType: document.getElementById('discount-type').value,
                    value: parseFloat(document.getElementById('promo-value').value) || 0,
                    expiresAt: expiryDate ? firebase.firestore.Timestamp.fromDate(new Date(expiryDate)) : null,
                    minCartValue: parseFloat(document.getElementById('promo-min-value').value) || 0,
                };
                await db.collection('promo_codes').doc(code).set(promoData);
                status.textContent = 'Promo code created successfully!'; status.className = 'status-message success';
                promoForm.reset();
                await loadPromosToDelete(); // Refresh list
            } catch (error) {
                console.error("Error adding promo code:", error);
                status.textContent = `Error: ${error.message}`; status.className = 'status-message error';
            } finally { btn.disabled = false; }
        }

        // --- LOAD & RENDER LISTS FOR DELETION ---
        async function loadProductsToDelete() {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '<h2>Existing Products</h2>';
            const snapshot = await db.collection('products').orderBy('name').get();
            if (snapshot.empty) {
                container.innerHTML += '<p>No products found.</p>';
                return;
            }
            snapshot.forEach(doc => {
                const product = doc.data();
                const itemEl = document.createElement('div');
                itemEl.className = 'list-item';
                itemEl.innerHTML = `
                    <div class="list-item-info">
                        <strong>${product.name}</strong>
                        <span>ID: ${product.id} | Category: ${product.category} | Price: ${product.price.toFixed(2)}</span>
                    </div>
                    <button class="btn-danger delete-product-btn" data-id="${product.id}">Delete</button>`;
                container.appendChild(itemEl);
            });
        }

        async function loadPromosToDelete() {
            const container = document.getElementById('promo-list-container');
            // container.innerHTML = '<h2>Existing Promo Codes</h2>';
            const snapshot = await db.collection('promo_codes').orderBy('code').get();
            if (snapshot.empty) {
                container.innerHTML += '<p>No promo codes found.</p>';
                return;
            }
            snapshot.forEach(doc => {
                const promo = doc.data();
                const itemEl = document.createElement('div');
                itemEl.className = 'list-item';
                const expiry = promo.expiresAt ? promo.expiresAt.toDate().toLocaleDateString() : 'No Expiry';
                itemEl.innerHTML = `
                    <div class="list-item-info">
                        <strong>${promo.code}</strong>
                        <span>Type: ${promo.discountType} | Value: ${promo.value} | Expires: ${expiry}</span>
                    </div>
                    <button class="btn-danger delete-promo-btn" data-id="${promo.code}">Delete</button>`;
                container.appendChild(itemEl);
            });
        }
        
        // --- DELETE HANDLERS ---
        async function handleDeleteProduct(e) {
            if (!e.target.classList.contains('delete-product-btn')) return;
            const btn = e.target;
            const productId = btn.dataset.id;
            if (confirm(`Are you sure you want to delete product with ID: ${productId}?`)) {
                btn.disabled = true;
                btn.textContent = 'Deleting...';
                try {
                    await db.collection('products').doc(productId).delete();
                    btn.closest('.list-item').remove();
                } catch (error) {
                    console.error("Error deleting product:", error);
                    alert("Could not delete product. See console for details.");
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                }
            }
        }

        async function handleDeletePromo(e) {
            if (!e.target.classList.contains('delete-promo-btn')) return;
            const btn = e.target;
            const promoId = btn.dataset.id;
            if (confirm(`Are you sure you want to delete promo code: ${promoId}?`)) {
                btn.disabled = true;
                btn.textContent = 'Deleting...';
                try {
                    await db.collection('promo_codes').doc(promoId).delete();
                    btn.closest('.list-item').remove();
                } catch (error) {
                    console.error("Error deleting promo code:", error);
                    alert("Could not delete promo code. See console for details.");
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                }
            }
        }
    </script>
</body>
</html>
